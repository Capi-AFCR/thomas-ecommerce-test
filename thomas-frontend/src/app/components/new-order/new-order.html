<mat-card class="new-order-card">
  <mat-card-title>Nueva Orden</mat-card-title>
  <div class="scrollable-content">
    <mat-card-content>
      <h3>Selecciona un Producto y Cantidad</h3>
      <form [formGroup]="orderForm" (ngSubmit)="onSubmit()" class="order-form">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Producto</mat-label>
          <mat-select formControlName="selectedProductId" required>
            <mat-option *ngFor="let product of products" [value]="product.id">
              {{ product.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="orderForm.get('selectedProductId')?.hasError('required')">
            El producto es requerido
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Cantidad</mat-label>
          <input matInput type="number" formControlName="quantity" min="1" required />
          <mat-error *ngIf="orderForm.get('quantity')?.hasError('required')">
            La cantidad es requerida
          </mat-error>
          <mat-error *ngIf="orderForm.get('quantity')?.hasError('min')">
            La cantidad debe ser mayor o igual a 1
          </mat-error>
        </mat-form-field>
        <div class="form-options">
          <button
            mat-raised-button
            color="warn"
            type="button"
            (click)="addRandomProducts()"
            [disabled]="!products.length"
          >
            Generar Pedido Aleatorio
          </button>
        </div>
        <div class="estimate-total">
          <p>Total Estimado (sin descuentos): {{ calculateTotal() | currency : 'USD' }}</p>
        </div>
        <button
          mat-raised-button
          color="accent"
          type="button"
          (click)="addProduct()"
          [disabled]="orderForm.invalid"
        >
          Añadir Producto
        </button>
      </form>

      <h3>Productos Añadidos</h3>
      <div class="table-container" *ngIf="addedProductsFormArray.length > 0">
        <table mat-table [dataSource]="addedProductsData">
          <ng-container matColumnDef="product">
            <th mat-header-cell *matHeaderCellDef>Producto</th>
            <td mat-cell *matCellDef="let row">{{ row.product }}</td>
          </ng-container>
          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef>Cantidad</th>
            <td mat-cell *matCellDef="let row">{{ row.quantity }}</td>
          </ng-container>
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let row" class="action-buttons">
              <button mat-button color="warn" (click)="removeAddedProduct(row.index)">
                Eliminar
              </button>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="addedProductsColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: addedProductsColumns"></tr>
        </table>
      </div>
      <div *ngIf="addedProductsFormArray.length === 0" class="no-data-message">
        No hay productos añadidos.
      </div>
    </mat-card-content>
  </div>
  <mat-dialog-actions class="dialog-actions">
    <button mat-stroked-button color="primary" (click)="onCancel()">Cancelar</button>
    <button
      mat-raised-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="addedProductsFormArray.length === 0"
    >
      Guardar Orden
    </button>
  </mat-dialog-actions>
</mat-card>
